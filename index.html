<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Next Bill</title>
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="ios6-wallpaper">
  <div class="wrap">
    <div class="ios6-navbar">
      <div class="ios6-title">Next Bill</div>
      <div class="ios6-actions">
        <button class="ios6-btn" id="btnSidebar">☰</button>
        <button class="ios6-btn" id="btnTheme">Theme</button>
      </div>
    </div>

    <!-- NEW NAV -->
    <div class="seg ios6-seg" role="tablist">
      <button class="active" data-tab="quick" id="tabBtnQuick">Quick Check</button>
      <button data-tab="statements" id="tabBtnStatements">Statements</button>
      <button data-tab="insights" id="tabBtnInsights">Insights</button>
      <button data-tab="profile" id="tabBtnProfile">Profile</button>
    </div>

    <div class="spacer"></div>

    <!-- QUICK CHECK -->
    <section class="card ios6-card" id="tab-quick">
      <div class="section-title">
        <div>
          <div class="h">Quick Check</div>
          <div class="muted small">Anchor-first SAFE/NOT SAFE.</div>
        </div>
        <div class="row">
          <button class="ios6-btn primary" id="btnCompute">Compute</button>
        </div>
      </div>

      <div class="note">
        This mode uses <b>today balances + due dates</b>. Statements are optional and only improve Insights.
        Data stays on-device. <a href="privacy.html" target="_blank">Privacy</a>
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div class="field">
          <label>Cash today (total)</label>
          <input id="qcCashToday" type="number" step="0.01" />
        </div>
        <div class="field">
          <label>Buffer floor (minimum safe balance)</label>
          <input id="qcBufferFloor" type="number" step="0.01" />
        </div>
        <div class="field">
          <label>Projection horizon (days)</label>
          <input id="qcHorizonDays" type="number" min="14" max="365" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div class="field">
          <label>Rent amount</label>
          <input id="rentAmount" type="number" step="0.01" />
        </div>
        <div class="field">
          <label>Rent due day (1–31)</label>
          <input id="rentDueDay" type="number" min="1" max="31" />
        </div>
        <div class="field">
          <label>Note (optional)</label>
          <input id="note" type="text" placeholder="optional" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="margin-top:4px;">
        <div>
          <div class="h">Income</div>
          <div class="muted small">Used to forecast the anchor windows.</div>
        </div>
        <button class="ios6-btn" id="btnAddIncome">Add income</button>
      </div>

      <div id="incomeList"></div>

      <div class="divider"></div>

      <div class="section-title" style="margin-top:4px;">
        <div>
          <div class="h">Debts</div>
          <div class="muted small">Credit cards + LOC. Due date is anchor.</div>
        </div>
        <button class="ios6-btn" id="btnAddDebt">Add debt</button>
      </div>

      <div id="debtList"></div>

      <div class="divider"></div>

      <div class="section-title" style="margin-top:4px;">
        <div>
          <div class="h">Planned expenses</div>
          <div class="muted small">Optional. Use for “Flight tickets”, etc.</div>
        </div>
        <button class="ios6-btn" id="btnAddPlanned">Add planned</button>
      </div>

      <div id="plannedList"></div>

      <div class="divider"></div>

      <div class="section-title">
        <div class="h">Decision</div>
        <button class="ios6-btn" id="btnToggleDetails">Show details</button>
      </div>

      <!-- Anchor cards -->
      <div id="anchorCards"></div>

      <!-- Details (hidden) -->
      <div id="detailsWrap" class="hidden" style="margin-top:12px;">
        <div class="kpis" id="kpiGrid"></div>
        <div class="spacer"></div>

        <table>
          <thead>
            <tr>
              <th style="width:140px;">Date</th>
              <th>Event</th>
              <th style="width:120px;" class="right">Inflow</th>
              <th style="width:120px;" class="right">Outflow</th>
              <th style="width:140px;" class="right">Balance</th>
              <th style="width:110px;">Flag</th>
            </tr>
          </thead>
          <tbody id="eventsTbody"></tbody>
        </table>

        <div class="note" id="warnings"></div>
      </div>
    </section>

    <!-- STATEMENTS -->
    <section class="card hidden ios6-card" id="tab-statements">
      <div class="section-title">
        <div>
          <div class="h">Statements</div>
          <div class="muted small">CSV import (bank-agnostic mapping). Stored locally (IndexedDB).</div>
        </div>
        <div class="row">
          <label class="ios6-btn filebtn">
            Upload CSV
            <input id="csvFile" type="file" accept=".csv,text/csv" />
          </label>
          <button class="ios6-btn" id="btnClearStatements">Clear statements</button>
        </div>
      </div>

      <div class="note">
        First time: upload a 3–6 month CSV and map columns once. Next imports reuse your saved mapping.
        No OCR, no bank API, no server calls.
      </div>

      <div class="divider"></div>

      <div id="mapWizard" class="hidden">
        <div class="section-title">
          <div>
            <div class="h">Mapping Wizard</div>
            <div class="muted small">Confirm columns → preview 10 normalized rows.</div>
          </div>
          <button class="ios6-btn primary" id="btnConfirmMapping">Confirm mapping</button>
        </div>

        <div class="grid">
          <div class="field">
            <label>Date column</label>
            <select id="mapDate"></select>
          </div>
          <div class="field">
            <label>Description column</label>
            <select id="mapDesc"></select>
          </div>
          <div class="field">
            <label>Amount style</label>
            <select id="mapAmountMode">
              <option value="signed">Signed Amount (single column)</option>
              <option value="debitcredit">Debit + Credit columns</option>
              <option value="amounttype">Amount + Type column</option>
            </select>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="field">
            <label>Amount column (if Signed Amount)</label>
            <select id="mapAmount"></select>
          </div>
          <div class="field">
            <label>Debit column (if Debit+Credit)</label>
            <select id="mapDebit"></select>
          </div>
          <div class="field">
            <label>Credit column (if Debit+Credit)</label>
            <select id="mapCredit"></select>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="field">
            <label>Type column (if Amount+Type)</label>
            <select id="mapType"></select>
          </div>
          <div class="field">
            <label>Debit tokens (comma separated)</label>
            <input id="mapDebitTokens" type="text" value="debit,withdrawal,purchase,dr" />
          </div>
          <div class="field">
            <label>Account column (optional)</label>
            <select id="mapAccount"></select>
          </div>
        </div>

        <!-- ADD THIS NEW GRID RIGHT AFTER IT -->
        <div class="grid" style="margin-top:10px;">
          <div class="field">
            <label>Account label for this CSV (recommended)</label>
            <input id="mapFileAccountLabel" type="text" placeholder="e.g., AMEX, SCOTIA_CC, SCOTIA_LOC, SCOTIA_DEBIT" />
          </div>
          <div class="field">
            <label></label>
            <div class="note">
              If the CSV has no account column, this label will be applied to every imported row.
              This is required to compute per-account statement cycles.
            </div>
          </div>
          <div class="field"></div>
        </div>


        <div class="divider"></div>

        <div class="h">Preview (normalized)</div>
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th style="width:140px;">date</th>
              <th>description</th>
              <th style="width:140px;" class="right">amount</th>
              <th style="width:160px;">account</th>
            </tr>
          </thead>
          <tbody id="previewTbody"></tbody>
        </table>

        <div class="note" id="mapWarnings"></div>
      </div>

      <div id="statementStatus" class="note"></div>
    </section>

    <!-- INSIGHTS -->
    <section class="card hidden ios6-card" id="tab-insights">
      <div class="section-title">
        <div>
          <div class="h">Insights</div>
          <div class="muted small">Enabled only when statement data exists.</div>
        </div>
      </div>

      <div class="kpis" id="coverageKpis"></div>

      <div class="divider"></div>

      <div id="insightsBody" class="note">
        Import statements to enable charts (category, trends, budget vs actual). This tab stays honest:
        if coverage is low, it will warn you instead of pretending accuracy.
      </div>
    </section>

    <!-- PROFILE -->
    <section class="card hidden ios6-card" id="tab-profile">
      <div class="section-title">
        <div>
          <div class="h">Profile</div>
          <div class="muted small">Export/import your local profile. Clear everything anytime.</div>
        </div>
        <div class="row">
          <button class="ios6-btn" id="btnExportProfile">Export profile</button>
          <label class="ios6-btn filebtn">
            Import profile
            <input id="importProfileFile" type="file" accept="application/json" />
          </label>
          <button class="ios6-btn danger" id="btnResetAll">Reset device data</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="note">
        Profile includes your saved mapping rules and Quick Check settings. It does not require any online account.
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div class="field">
          <label>Default horizon days</label>
          <input id="profileDefaultHorizon" type="number" min="14" max="365" />
        </div>
        <div class="field">
          <label>Default buffer floor</label>
          <input id="profileDefaultBuffer" type="number" step="0.01" />
        </div>
        <div class="field">
          <label>Expenses-first on same day</label>
          <select id="profileSameDayOrder">
            <option value="expensesFirst">Expenses first (conservative)</option>
            <option value="incomeFirst">Income first</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="note">
        Privacy page: <a href="privacy.html" target="_blank">privacy.html</a>
      </div>
    </section>

  </div>

  <!-- SIDEBAR -->
  <div class="backdrop hidden" id="backdrop"></div>
  <aside class="drawer hidden" id="drawer">
    <div class="drawer-head">
      <div class="h">Menu</div>
      <button class="ios6-btn" id="btnCloseDrawer">Close</button>
    </div>

    <div class="drawer-card">
      <div class="muted small">Trust posture</div>
      <div class="small">No accounts. No analytics. No server calls.</div>
      <div class="small">Export profile anytime.</div>
    </div>
  </aside>

  <script src="app.js"></script>
</body>
</html>
